
  
  # Handling Join Expressions

The `pql` package provides support for handling join expressions in the Pipeline Query Language (PQL). The parsing and compilation of join expressions are handled within the `splitQueries` function.

When the parser encounters a `JoinOperator`, the `splitQueries` function generates a subquery for the left and right sides of the join, as well as the join condition. The resulting SQL is constructed using the following steps:

1. The `JoinOperator` is extracted from the parsed expression, and the left and right sides are recursively processed by calling `splitQueries` on the `op.Right` expression.

2. The SQL for the left side is generated by either using the corresponding existing subquery or creating a new subquery from the data source (`expr.Source`).

3. The SQL for the right side is obtained from the last subquery generated in the previous step.

4. A join condition is built using the `buildJoinCondition` function, which combines the individual conditions provided in `op.Conditions`. Simple join conditions involving single identifiers are rewritten using the `rewriteSimpleJoinCondition` function to handle the special case where Clickhouse requires a basic equality comparison between left and right columns in a JOIN.

5. The join SQL is constructed by combining the left and right subqueries, along with the join condition. The appropriate join type (e.g., `INNER JOIN`, `LEFT OUTER JOIN`) is determined based on the `op.Flavor`.

6. A new subquery is created with the generated join SQL and appended to the list of subqueries.

The `hasJoinTerms` function is used to detect if an expression contains references to the special `$left` or `$right` identifiers, which are used to represent the left and right sides of the join, respectively.

By handling join expressions in this manner, the `pql` package can effectively translate PQL join statements into equivalent SQL statements, including support for different join types and condition handling.
  
  